/**
 * @author Rohan K.M rohan.mahendroo@gmail.com
 * ServiceHandler
 * com.app.project.acropolis
 * ServiceHandler.java
 * Created - 2013-10-11 3:09:55 PM	
 * Modified - 2013-10-11 3:09:55 PM
 * TODO
 * NOTES - 
 */
package com.app.project.acropolis;

import android.app.Service;
import android.content.ContentResolver;
import android.content.Context;
import android.content.Intent;
import android.database.ContentObserver;
import android.database.Cursor;
import android.net.Uri;
import android.os.IBinder;
import android.telephony.PhoneStateListener;
import android.telephony.TelephonyManager;

/**
 * @author CPH-iMac
 *
 */
public class ServiceHandler extends Service 
{
	Context context = getApplicationContext();
	
	final String msgOutUri = "content://sms";
	Uri outUri = Uri.parse(msgOutUri);
	int outgoingCounter = 0;
	int incomingCounter = 0;
	
	@Override
	public IBinder onBind(Intent intent) {
		// TODO Auto-generated method stub
		return null;
	}

	public void onCreate()
	{
		setupCallMonitoring();
		
	}
	
	public void setupCallMonitoring()
	{
		TelephonyManager telephonyManager = (TelephonyManager) 
				getApplicationContext().
				getSystemService(Context.TELEPHONY_SERVICE);
		
		telephonyManager.listen(new CallStateListener(),
				PhoneStateListener.LISTEN_CALL_STATE);
	}
	
	public void setupMessageMonitoring()
	{
		ContentResolver contentResolver = context.getContentResolver();

		contentResolver.registerContentObserver(outUri, true, new ContentObserver(null)
		{
			//TODO
			public void onChange(boolean selfChange)
			{
				super.onChange(selfChange);
				Cursor smsCursor = context.getContentResolver().query(outUri,
						new String[]{"type"}, null, null,null);


				if(smsCursor.moveToFirst())
				{
					if(smsCursor.getString(smsCursor.getColumnIndex("type")).equalsIgnoreCase("1"))
					{
						//received
						++incomingCounter;
						Logger.Debug("msg received count:"+incomingCounter);
					}
					else if(smsCursor.getString(smsCursor.getColumnIndex("type")).equalsIgnoreCase("2"))
					{
						//sent
						++outgoingCounter;
						Logger.Debug("msg sent count::"+outgoingCounter);
					}
				}

			}

		});
	}
	
	public int onStartCommand(Intent intent,int arg0,int arg1)
	{
		return Service.START_STICKY;
	}
	
}
