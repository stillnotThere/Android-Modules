/**
 * @author Rohan K.M rohan.mahendroo@gmail.com
 * RoamingListener
 * com.app.project.acropolis
 * RoamingListener.java
 * Created - 2013-10-11 3:33:19 PM	
 * Modified - 2013-10-11 3:33:19 PM
 * TODO
 * NOTES - 
 */
package com.app.project.acropolis.monitor;

import android.content.BroadcastReceiver;
import android.content.Context;
import android.content.Intent;
import android.net.ConnectivityManager;
import android.net.NetworkInfo;
import android.os.Handler;
import android.telephony.TelephonyManager;

import com.app.project.acropolis.GlobalConstants;
import com.app.project.acropolis.Logger;

/**
 * @author CPH-iMac
 *
 */
public class RoamingListener extends BroadcastReceiver
{
	public final String[] CAN_OPERATORS = {"Rogers","TELUS"};
	public boolean roaming = false;

	public ConnectivityManager connectivityManager = null;
	public NetworkInfo networkInfo = null;

	public Context _context = null;
	public Intent _intent = null;

	@Override
	public void onReceive(Context context, Intent intent)
	{
		_context = context;
		_intent = intent;
		if(checkNetworkInfo().equalsIgnoreCase(GlobalConstants.MOBILE_NETWORK))
		{
			checkRoaming();
		}
	}

	private String checkNetworkInfo()
	{
		ConnectivityManager _cm = (ConnectivityManager) 
				_context.getSystemService(Context.CONNECTIVITY_SERVICE);
		String type = "";
		if((networkInfo = _cm.getActiveNetworkInfo())!=null)
		{
			type = networkInfo.getTypeName();
		}
		Logger.Debug("Network:::"+type+
				"\n\t\tisRoaming::::"+networkInfo.isRoaming());
		return type;
	}

	/**
	 * Checks roaming operator if applicable
	 * @return true if Roaming, false if Local
	 */
	public boolean checkRoaming()
	{
		TelephonyManager _tm = (TelephonyManager)
				_context.getSystemService(Context.TELEPHONY_SERVICE);
		boolean ret = false;
		if(String.valueOf(_tm.isNetworkRoaming())!=null)
			ret = changeRoaming(_tm);
		return ret;
	}

	public boolean changeRoaming(TelephonyManager tm)
	{
		try{
			TelephonyManager _tm = tm;
			Logger.Debug("Roaming BR Context:::\t\t"+_context.toString());
			if(_tm.getNetworkOperatorName().length()>0 ||
					_tm.getNetworkOperatorName()!=null)
			{
				for(int i=0;i<CAN_OPERATORS.length;i++)
				{
					if(!_tm.
							getNetworkOperatorName().
							equalsIgnoreCase(CAN_OPERATORS[i]))
					{
						roaming = true;
						Handler triggerImmediateRoaming = new Handler();
						triggerImmediateRoaming.post(new TriggerEvent());
						break;
					}
					else
					{
						roaming = false;
					}
				}
			}
//			ContentValues cv = new ContentValues();
//			cv.put(DBOpenHelper.ROAMING, String.valueOf(roaming));
//			DBAdapter.update(cv);
		} catch(NullPointerException e) {
			e.printStackTrace();
		}
		return roaming;
	}

	public class TriggerEvent implements Runnable
	{
		public void run()
		{
			
		}
		
	}
	
}
