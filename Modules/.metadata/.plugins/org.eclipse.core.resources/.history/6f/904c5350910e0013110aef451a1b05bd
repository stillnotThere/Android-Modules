/**
 * @author Rohan K.M rohan.mahendroo@gmail.com
 * MinutesListenerModule
 * com.acropolis.radio.module.monitoring.controller
 * Interceptor.java
 * Created - 2013-07-26	
 * Modified - 2013-07-31
 * TODO
 */
package com.acropolis.radio.module.monitor.controller;

import android.os.AsyncTask;
import android.provider.CallLog;
import android.telephony.PhoneStateListener;
import android.telephony.ServiceState;
import android.telephony.TelephonyManager;

import com.acropolis.radio.module.RadioModuleActivity;
import com.acropolis.radio.module.global.DBConstants;
import com.acropolis.radio.module.logger.Logger;
import com.acropolis.radio.module.model.DBAdapter;

public class CallInterceptor 
{

	public static class CallStateListener extends PhoneStateListener
	{
		static DBAdapter dbAdapter = new DBAdapter(RadioModuleActivity.getAppContext());
		private CallLogAT callLog = new CallLogAT();

		public void onCallStateChanged(int state,String incomingNumber)
		{
			
			switch (state)
			{
			case TelephonyManager.CALL_STATE_IDLE:
			{
				RadioEngine.IDLE = true;
				if(RadioEngine._INCOMING)
				{
					RadioEngine._INCOMING = false;
				}
			};

			case TelephonyManager.CALL_STATE_RINGING:
			{
				RadioEngine.RINGING = true;
			};

			case TelephonyManager.CALL_STATE_OFFHOOK:
			{
				RadioEngine.OFFHOOK = true;
				if(RadioEngine.IDLE && RadioEngine.RINGING && RadioEngine.OFFHOOK)
				{
					RadioEngine._INCOMING = true;

					RadioEngine._OUTGOING = false;
					callLog.execute();
				}

				if(RadioEngine.IDLE && RadioEngine.OFFHOOK)
				{
					RadioEngine._OUTGOING = true;

					RadioEngine._INCOMING = false;
				}

			};
			}
		}

		//look over Handler(non UI thread)
		private class CallLogAT extends AsyncTask<Void,Void,Boolean>
		{

			@Override
			protected Boolean doInBackground(Void... params) {
				RadioEngine.callType = CallLog.Calls.TYPE;
				Logger.Information("Call Type ::"+RadioEngine.callType);

				if(RadioEngine.callType.equalsIgnoreCase(RadioEngine.INCOMING))
				{
					Logger.Information("Incoming");
					RadioEngine.callPhoneNumber = CallLog.Calls.NUMBER;
					RadioEngine.callDuration = Integer.decode(CallLog.Calls.DURATION);
					RadioEngine.callTimeStamp = Integer.decode(CallLog.Calls.DATE);
					
					DBAdapter.insertValues(DBConstants.INCOMINGCALL,
							RadioEngine.callDuration.toString());
					
					
				}
				if(RadioEngine.callType.equalsIgnoreCase(RadioEngine.OUTGOING))
				{
					Logger.Information("Outgoing");
					RadioEngine.callPhoneNumber = CallLog.Calls.NUMBER;
					RadioEngine.callDuration = Integer.decode(CallLog.Calls.DURATION);
					RadioEngine.callTimeStamp = Integer.decode(CallLog.Calls.DATE);
				}
				if(RadioEngine.callType.equalsIgnoreCase(RadioEngine.MISSED))
				{Logger.Information("Missed");}
				return true;
			}
		}

	}

	/**
	 *	Listens for Radio Service changes 
	 */
	public static class ServiceStateListener extends PhoneStateListener
	{
		/**
		 * {@link android.telephony.PhoneStateListener#onServiceStateChanged(ServiceState)}
		 * radio-registration active monitoring incld. radio off(explicitly)
		 * states::
		 * 	ACITVE_SERVICE
		 * 	INACTIVE_SERVICE
		 * 	INACTIVE_POWER_OFF
		 */
		public void onServiceStateChanged(ServiceState serviceState)
		{
			Logger.Information("ServiceState changed");
			switch(serviceState.getState())
			{

			case ServiceState.STATE_IN_SERVICE:
			{RadioEngine.CURRENT_SERVICE_STATE = RadioEngine.ACTIVE_SERVICE;};

			case ServiceState.STATE_POWER_OFF:
			{RadioEngine.CURRENT_SERVICE_STATE = RadioEngine.INACTIVE_POWER_OFF;};

			case ServiceState.STATE_OUT_OF_SERVICE:
			{RadioEngine.CURRENT_SERVICE_STATE = RadioEngine.INACTIVE_SERVICE;};

			case ServiceState.STATE_EMERGENCY_ONLY:
			{RadioEngine.CURRENT_SERVICE_STATE = RadioEngine.INACTIVE_SERVICE;};

			}
		}
	}
	
}